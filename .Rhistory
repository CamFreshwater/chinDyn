surv %>%
filter(!grepl("COLR", region) & smolt == "streamtype") %>%
select(stock, stock_name, region) %>%
distinct()
surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
select(stock, stock_name, region) %>%
distinct()
surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
select(stock, stock_name, region) %>%
droplevels()
surv_trim_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
select(stock, stock_name, region) %>%
droplevels()
tibble(group = levels(surv_trim_j$j_group)) %>%
mutate(
m_mat = surv_trim2 %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
surv_trim_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
select(stock, stock_name, region) %>%
droplevels()
surv_tbl <- tibble(group = levels(surv_trim_j$j_group)) %>%
mutate(
m_mat = surv_trim_j %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
surv_trim_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels()
tibble(group = levels(surv_trim_j$j_group)) %>%
mutate(
m_mat = surv_trim_j %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
tibble(group = levels(surv_trim_j$j_group)) %>%
mutate(
m_mat = surv_trim_j %>%
filter(!is.na(M)) %>%
group_split(j_group) %>%
map(., make_mat)
)
surv_tbl$names <- map(surv_tbl$m_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., surv %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
surv_tbl <- tibble(group = levels(surv_trim_j$j_group)) %>%
mutate(
m_mat = surv_trim_j %>%
filter(!is.na(M)) %>%
group_split(j_group) %>%
map(., make_mat)
)
surv_tbl$names <- map(surv_tbl$m_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., surv %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
surv_tbl
# fit models to each region, then export to Rmd
dfa_list <- map(surv_tbl$m_mat, function(x) {
fit_dfa(y = x, num_trends = 2, zscore = TRUE, iter = 8000, chains = 1,
thin = 1, control = list(adapt_delta = 0.95, max_treedepth = 20))
})
# fit models to each region, then export to Rmd
dfa_list <- map(surv_tbl$m_mat, function(x) {
fit_dfa(y = x, num_trends = 2, zscore = TRUE, iter = 2000, chains = 4,
thin = 1, control = list(adapt_delta = 0.95, max_treedepth = 20))
})
surv_tbl$dfa_two_trend <- dfa_list
make_surv_tbl <- function (dat_in) {
surv_tbl <- tibble(group = levels(dat_in$group)) %>%
mutate(
m_mat = dat_in %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
surv_tbl$names <- map(surv_tbl$m_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., surv %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
return(surv_tbl)
}
## JUVENILE GROUPINGS  ---------------------------------------------------------
surv_trim_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
select(-a_group)
make_surv_tbl <- function (dat_in) {
surv_tbl <- tibble(group = levels(dat_in$group)) %>%
mutate(
m_mat = dat_in %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
surv_tbl$names <- map(surv_tbl$m_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., surv %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
return(surv_tbl)
}
make_surv_tbl(surv_trim_j %>% rename(group = j_group))
surv_tbl_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(j_group = group) %>%
make_surv_tbl()
surv_tbl_a <- surv %>%
# filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(a_group = group) %>%
make_surv_tbl()
surv_tbl_a
surv_tbl_a
surv_tbl_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(j_group = group) %>%
make_surv_tbl()
surv_tbl_a <- surv %>%
# filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(a_group = group) %>%
make_surv_tbl()
surv_tbl_j
## JUVENILE GROUPINGS  ---------------------------------------------------------
make_surv_tbl <- function (dat_in) {
surv_tbl <- tibble(group = levels(dat_in$group)) %>%
mutate(
m_mat = dat_in %>%
filter(!is.na(M)) %>%
group_split(group) %>%
map(., make_mat)
)
surv_tbl$names <- map(surv_tbl$m_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., surv %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
return(surv_tbl)
}
surv_tbl_a <- surv %>%
# filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(a_group = group)
glimpse(srv_tbl_a)
glimpse(surv_tbl_a)
dev.off()
dev.off()
dev.off()
surv %>%
# filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(a_group = group)
surv %>%
rename(a_group = group)
glimpse(surv)
surv %>%
rename(a_group = group)
surv_tbl_j <- surv %>%
filter(!(grepl("COLR", region) & smolt == "streamtype")) %>%
droplevels() %>%
rename(group = j_group) %>%
make_surv_tbl()
surv_tbl_a <- surv %>%
rename(group = a_group) %>%
make_surv_tbl()
glimpse(surv_tbl_j)
glimpse(surv_tbl_a)
surv_tbl_j$dfa_two_trend <- dfa_list
surv_tbl_j
saveRDS(surv_tbl_j, here::here("data", "dfaBayesFits", "two-trend-fits-juv.rds"))
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend), function (group_name, x) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum) +
ylim(-2, 2))
dev.off()
}
)
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend), function (group_name, x) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum) +
ylim(-2, 2))
dev.off()
}
)
?plot_fitted
?plot_loadings
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x, names = names))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum, names = names) +
ylim(-2, 2))
dev.off()
}
)
surv_tbl_j$names
plot_fitted(surv_tbl_j$dfa_two_trend[[1]], names = surv_tbl_j$names[[1]])
plot_fitted(surv_tbl_j$dfa_two_trend[[1]], names = surv_tbl_j$names[[1]])
dev.off
dev.off()
plot_fitted(surv_tbl_j$dfa_two_trend[[1]], names = surv_tbl_j$names[[1]])
plot_fitted(surv_tbl_j$dfa_two_trend[[1]])
surv_tbl_j$names[[1]]
plot_fitted(surv_tbl_j$dfa_two_trend[[1]], names = surv_tbl_j$names[[1]]$stock)
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock_name
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x, names = stock_names))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum, names = names) +
ylim(-2, 2))
dev.off()
}
)
surv_tbl_j
names <- surv_tbl_j$names
x <- surv_tbl_j$dfa_two_trend
stock_names <- names$stock_name
stock_names
names <- surv_tbl_j$names[[1]]
x <- surv_tbl_j$dfa_two_trend[[1]]
stock_names <- names$stock_name
stock_names
names <- surv_tbl_j$names[[1]]
x <- surv_tbl_j$dfa_two_trend[[1]]
stock_names <- names$stock
stock_names
plot_fitted(x, names = stock_names)
names <- surv_tbl_j$names[[2]]
x <- surv_tbl_j$dfa_two_trend[[2]]
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
plot_fitted(x, names = stock_names)
plot_fitted(x, names = stock_names)
dev.off()
dev.off()
plot_fitted(x, names = stock_names)
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x, names = stock_names))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum, names = names) +
ylim(-2, 2))
dev.off()
}
)
names$stock
class(names$stock)
dev.off()
dev.off()
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
print(plot_fitted(x, names = stock_names))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum, names = names) +
ylim(-2, 2))
dev.off()
}
)
dev.off()
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = names) +
ylim(-2, 2)
dev.off()
}
)
?pmap
# save figs
surv_tbl_j %>%
pmap(list(group, dfa_two_trend, names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = names) +
ylim(-2, 2)
dev.off()
}
)
# save figs
surv_tbl_j %>%
pmap(list(group, dfa_two_trend, names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
# pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = names) +
ylim(-2, 2)
# dev.off()
}
)
# save figs
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
# pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = names) +
ylim(-2, 2)
# dev.off()
}
)
surv_tbl_j
# save figs
print_dfa_plots <- function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = names) +
ylim(-2, 2)
dev.off()
}
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
print_dfa_plots)
dev.off()
dev.off()
surv_tbl_j$group
surv_tbl_j$names
# save figs
print_dfa_plots <- function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = stock_names) +
ylim(-2, 2)
dev.off()
}
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names),
print_dfa_plots)
surv_tbl_a$dfa_two_trend <- map(surv_tbl_a$m_mat, function(x) {
fit_dfa(y = x, num_trends = 2, zscore = TRUE, iter = 2000, chains = 4,
thin = 1, control = list(adapt_delta = 0.95, max_treedepth = 20))
})
surv_tbl_a
saveRDS(surv_tbl_a, here::here("data", "dfaBayesFits", "two-trend-fits-adult.rds"))
# save figs
print_dfa_plots <- function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "juv_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = stock_names) +
ylim(-2, 2)
dev.off()
}
pdf(here::here("figs", "dfa", "bayes", "adult_grouping", file_name))
# save figs
print_dfa_plots <- function (group_name, x, names) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", "adult_grouping", file_name))
plot_fitted(x, names = stock_names)
plot_trends(rot_dum)
plot_loadings(rot_dum, names = stock_names) +
ylim(-2, 2)
dev.off()
}
dev.off()
dev.off()
dev.off()
dev.off()
dev.off()
pmap(list(surv_tbl_a$group, surv_tbl_a$dfa_two_trend, surv_tbl_a$names),
print_dfa_plots)
pmap(list(surv_tbl_a$group, surv_tbl_a$dfa_two_trend, surv_tbl_a$names),
print_dfa_plots)
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names,
"juv_grouping"),
print_dfa_plots)
# save figs
print_dfa_plots <- function (group_name, x, names, dir_name) {
file_name <- paste(group_name, "2trend_fit.pdf", sep = "_")
stock_names <- names$stock
rot_dum <- rotate_trends(x)
pdf(here::here("figs", "dfa", "bayes", dir_name, file_name))
print(plot_fitted(x, names = stock_names))
print(plot_trends(rot_dum))
print(plot_loadings(rot_dum, names = stock_names) +
ylim(-2, 2))
dev.off()
}
pmap(list(surv_tbl_j$group, surv_tbl_j$dfa_two_trend, surv_tbl_j$names,
"juv_grouping"),
print_dfa_plots)
pmap(list(surv_tbl_a$group, surv_tbl_a$dfa_two_trend, surv_tbl_a$names,
"adult_grouping"),
print_dfa_plots)
?plot_trends
surv_tbl_a
colnames(surv_tbl_a$m_mat[1])
surv_tbl_a$m_mat[1]
?plot_fitted
surv %>% select(stock, stock_name) %>% distinct()
metadata
View(metadata)
surv %>% select(stock, stock_name) %>% distinct()
library(tidyverse); library(here); library(ggplot2); library(viridis)
# load and initial clean
seals <- read.csv(here("data/salmonData/sealPopEst.csv"),
stringsAsFactors = FALSE) %>%
rename(year = "Estimate", mean = "Mean", low = "X2.5th", up = "X97.5th",
reg = "Region")
sogZP <- read.csv(here("data/salmonData/totalPreyAnomalies_SOG.csv"),
stringsAsFactors = FALSE)
viZP <- read.csv(here("data/salmonData/totalPreyAnomalies_sVI.csv"),
stringsAsFactors = FALSE)
newportCope <- read.csv(here("data/salmonData/copeIndices_newport.csv"),
stringsAsFactors = FALSE)
diet <- read.csv(here("data/salmonData/ckSummerDiet.csv"),
stringsAsFactors = FALSE)
whales <- read.csv(here("data/salmonData/rkw_salmon_jun2019.csv"),
stringsAsFactors = FALSE)
npgo <- read.csv(here("data/salmonData/npgo_jul2020.csv"),
stringsAsFactors = FALSE)
colnames(npgo) <- c("year", "month", "npgo")
pdo1 <- read.csv(here("data/salmonData/pdo_aug2020.csv"),
stringsAsFactors = FALSE)
pdo_date_list <- strsplit(as.character(pdo1$Date), "")
pdo <- pdo1 %>%
mutate(
year = map(pdo_date_list, function (x) paste0(x[1:4], sep = "",
collapse = "")) %>%
unlist() %>%
as.numeric(),
month = map(pdo_date_list, function (x) paste0(x[5:6], sep = "",
collapse = "")) %>%
unlist() %>%
as.numeric()
) %>%
select(year, month, pdo = Value)
sstArc <- read.csv(here("data/salmonData/johnstone_indicators.csv"),
stringsAsFactors = FALSE)
names(sstArc)[1] <- "year"
sstArc <- sstArc %>%  select(year, sst_arc = SSTarc)
biIndex <- read.csv(here("data/salmonData/bifurcation-index.csv"),
stringsAsFactors = FALSE) %>%
mutate(bi_stnd = scale(bifurcation_index))
# seal data
ggplot(seals, aes(x = year, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = low, ymax = up), alpha = 0.2) +
samSim::theme_sleekX() +
facet_wrap(~reg, scales = "free_y")
