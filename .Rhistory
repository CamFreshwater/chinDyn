# for oceanographic indices which have monthly values calculate annual means and
# means for April-July (priming period)
sstArc2 <- sstArc %>%
mutate(year_n = floor(year),
year_c = as.character(year_n),
month_cont = year - year_n,
month = round((month_cont * 12), digits = 0)
)
glimpse(sstArc2)
# for oceanographic indices which have monthly values calculate annual means and
# means for April-July (priming period)
sstArc2 <- sstArc %>%
mutate(year_n = floor(year),
year_c = as.character(year_n),
month_cont = (year - year_n) * 12,
month = round(month_cont, digits = 0)
)
glimpse(sstArc2)
# for oceanographic indices which have monthly values calculate annual means and
# means for April-July (priming period)
sstArc2 <- sstArc %>%
mutate(year_n = floor(year),
year_c = as.character(year_n),
month_cont = (year - year_n) * 12,
month = floor(month_cont)
)
sstArc2
?floor
# for oceanographic indices which have monthly values calculate annual means and
# means for April-July (priming period)
sstArc2 <- sstArc %>%
mutate(year_n = ceiling(year),
year_c = as.character(year_n),
month_cont = (year - year_n) * 12,
month = floor(month_cont)
)
?floor
sstArc2
# for oceanographic indices which have monthly values calculate annual means and
# means for April-July (priming period)
sstArc2 <- sstArc %>%
mutate(year_n = floor(year),
year_c = as.character(year_n),
month_cont = (year - year_n) * 12,
month = ceiling(month_cont)
)
sstArc2
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")
)
glimpse(phys_ocean)
glimpse(sstArc2)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year, month, sst_arc),
by = c("month", "year"))
glimpse(phys_ocean)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year"))
glimpse(phys_ocean)
tail(phys_ocean)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year"))
glimpse(phys_ocean)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year"))
npgo <- read.csv(here("data/salmonData/npgo_jul2020.csv"),
stringsAsFactors = FALSE) %>%
rename(year = YEAR, month = MONTH, npgo = NPGO.index)
pdo <- pdo1 %>%
mutate(
year = map(pdo_date_list, function (x) paste0(x[1:4], sep = "",
collapse = "")) %>%
unlist() %>%
as.numeric(),
month = map(pdo_date_list, function (x) paste0(x[5:6], sep = "",
collapse = "")) %>%
unlist() %>%
as.numeric()
) %>%
select(year, month, pdo = Value)
?pivot_longer
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n"))
glimpse(phys_ocean)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n")) %>%
group_by(year, prime_period, index) %>%
mutate(prime_anom = scale(mean(value))[ , 1])
glimpse(phys_ocean)
phy_ocean %>% arrange(index) %>% print(n = 50)
phys_ocean %>% arrange(index) %>% print(n = 50)
phys_ocean %>% filter(index == "pdo") %>% print(n = 50)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n")) %>%
group_by(year, prime_period, index) %>%
mutate(prime_anom = mean(value))
phys_ocean %>% filter(index == "pdo") %>% print(n = 50)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n")) %>%
group_by(year, prime_period, index) %>%
mutate(prime_mean = mean(value)) %>%
group_by(year, index) %>%
mutate(annual_mean = mean(value))
phys_ocean %>% filter(index == "pdo") %>% print(n = 50)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n")) %>%
group_by(year, prime_period, index) %>%
mutate(prime_mean = mean(value)) %>%
group_by(year, index) %>%
mutate(annual_mean = mean(value)) %>%
ungroup() %>%
mutate(prime_anom = scale(prime_mean)[ , 1])
phys_ocean %>% filter(index == "pdo") %>% print(n = 50)
phys_ocean <- left_join(pdo, npgo, by = c("month", "year")) %>%
left_join(., sstArc2 %>% select(year = year_n, month, sst_arc),
by = c("month", "year")) %>%
pivot_longer(., cols = c("pdo", "npgo", "sst_arc"), names_to = "index",
values_to = "value") %>%
#identify months making up priming period
mutate(prime_period = ifelse(month > 3 & month < 8, "y", "n")) %>%
group_by(year, prime_period, index) %>%
mutate(prime_mean = mean(value)) %>%
group_by(year, index) %>%
mutate(annual_mean = mean(value)) %>%
ungroup() %>%
mutate(prime_anom = scale(prime_mean)[ , 1],
annual_anom = scale(annual_mean)[ , 1]) %>%
filter(prime_period == "y") %>%
select(year, index, prime_mean:annual_anom) %>%
distinct()
head(phys_ocean)
?pivot_wider
phys_ocean_anom <- phys_ocean %>%
select(-prime_mean, -annual_mean) %>%
pivot_wider(names_from = index, values_from = c(prime_anom, annual_anom)) %>%
glimpse()
## consolidate all
covOut <- trimSeal %>%
full_join(bi_index %>% select(year, bi_anom = bi_stnd), by = "year") %>%
full_join(trimDiet, by = "year") %>%
full_join(trimEnv, by = "year")
glimpse(covOut)
glimpse(phys_ocean_anom)
## consolidate all anomalies
covOut <- phys_ocean_anom %>%
full_join(trimSeal, by = "year") %>%
full_join(bi_index %>% select(year, bi_anom = bi_stnd), by = "year") %>%
full_join(trimDiet, by = "year") %>%
full_join(trimEnv, by = "year")
glimpse(covOut)
## consolidate all anomalies
covOut <- phys_ocean_anom %>%
full_join(trimSeal, by = "year") %>%
full_join(bi_index %>% select(year, bi_anom = bi_stnd), by = "year") %>%
full_join(trimDiet, by = "year") %>%
full_join(trimEnv, by = "year")
write.csv(covOut, here("data/salmonData/survCovariateAnom.csv"), row.names = F)
## seal data
ggplot(seals, aes(x = year, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = low, ymax = up), alpha = 0.2) +
samSim::theme_sleekX() +
facet_wrap(~reg, scales = "free_y")
cov <- read.csv(here::here("data/salmonData/survCovariateAnom.csv"),
stringsAsFactors = FALSE)
glimpse(cov)
## Looks at covariates
cov_long <- cov %>%
pivot_longer(cols = 2:ncol(.), names_to = "metric", values_to = "anomaly")
glimpse(cov_long)
## Looks at covariates
cov_ts <- cov %>%
pivot_longer(cols = 2:ncol(.), names_to = "metric", values_to = "anomaly")  %>%
ggplot(.) +
geom_line(aes(x = year, y = anomaly)) +
ggsidekick::theme_sleek() +
# scale_x_continuous(breaks = c(1975, 1985, 1995, 2005, 2015)) +
facet_wrap(~metric)
cov_ts
## consolidate all anomalies
covOut <- phys_ocean_anom %>%
full_join(trimSeal, by = "year") %>%
full_join(bi_index %>% select(year, bi_anom = bi_stnd), by = "year") %>%
full_join(trimDiet, by = "year") %>%
full_join(trimEnv, by = "year") %>%
pivot_longer(cols = 2:ncol(.), names_to = "metric", values_to = "anomaly") %>%
mutate(
time_step = case_when(
grepl("prime", metric) ~ "seasonal",
TRUE ~ "annual"
),
class = case_when(
grepl("annual", metric) ~ "physical",
grepl("prime", metric) ~ "physical",
grepl("seal", metric) ~ "predator",
TRUE ~ "diet"
),
region = case_when(
class == "physical" ~ "basin",
metric == "cci_anom" ~ "ca_current",
metric %in% c("zp_env_anom", "fish_env_anom", "seal_anom") ~ "sog",
metric %in% c("boreal_anom", "cci_anom", "fish_diet_anom") ~ "wcvi"
)
)
covOut %>% filter(is.na(region))
glimpse(newportCope)
## consolidate all anomalies
covOut <- phys_ocean_anom %>%
full_join(trimSeal, by = "year") %>%
full_join(bi_index %>% select(year, bi_anom = bi_stnd), by = "year") %>%
full_join(trimDiet, by = "year") %>%
full_join(trimEnv, by = "year") %>%
pivot_longer(cols = 2:ncol(.), names_to = "metric", values_to = "anomaly") %>%
mutate(
time_step = case_when(
grepl("prime", metric) ~ "seasonal",
metric == "cci_anom" ~ "seasonal",
TRUE ~ "annual"
),
class = case_when(
grepl("annual", metric) ~ "physical",
grepl("prime", metric) ~ "physical",
metric == "bi_anom" ~ "physical",
grepl("seal", metric) ~ "predator",
TRUE ~ "diet"
),
region = case_when(
class == "physical" ~ "basin",
metric == "cci_anom" ~ "ca_current",
metric %in% c("zp_env_anom", "fish_env_anom", "seal_anom") ~ "sog",
metric %in% c("boreal_anom", "south_anom", "fish_diet_anom") ~ "wcvi"
)
)
covOut %>% filter(is.na(region))
covOut %>% select(metric, time_step, class, region) %>% distinct()
write.csv(covOut, here("data/salmonData/survCovariateAnom.csv"), row.names = F)
cov <- read.csv(here::here("data/salmonData/survCovariateAnom.csv"),
stringsAsFactors = FALSE)
glimpse(cov)
## Looks at covariates
cov_ts <- cov %>%
ggplot(.) +
geom_line(aes(x = year, y = anomaly, colour = class)) +
ggsidekick::theme_sleek() +
# scale_x_continuous(breaks = c(1975, 1985, 1995, 2005, 2015)) +
facet_wrap(~metric)
cov_ts
png(here::here("figs", "dfa", "covEffects", "cov_anomalies.png"), height = 5,
width = 7, units = "in", res = 300)
cov_ts
dev.off()
library(mgcv)
library(tidyverse)
cov <- read.csv(here("data/salmonData/survCovariateAnom.csv"), row.names = F)
cov <- read.csv(here("data/salmonData/survCovariateAnom.csv"),
stringsAsFactors = F)
glimpse(cov)
surv <- read.csv(here::here("data/salmonData/cwt_indicator_surv_clean.csv"),
stringsAsFactors = FALSE)
glimpse(surv)
unique(surv$region)
unique(surv$agg_reg)
glimpse(cov)
surv <- read.csv(here::here("data/salmonData/cwt_indicator_surv_clean.csv"),
stringsAsFactors = FALSE) %>%
filter(agg_reg == "SS") %>%
select(year, smolt, survival, M)
glimpse(surv)
?nest
glimpse(cov)
dat <- cov %>%
select(year:anomaly) %>%
nest(data = (year, anomaly))
dat <- cov %>%
select(year:anomaly) %>%
nest(data = c(year, anomaly))
dat
glimpse(surv)
surv <- read.csv(here::here("data/salmonData/cwt_indicator_surv_clean.csv"),
stringsAsFactors = FALSE) %>%
filter(agg_reg == "SS",
!is.na(surv)) %>%
select(year, stock, smolt, survival, M)
surv <- read.csv(here::here("data/salmonData/cwt_indicator_surv_clean.csv"),
stringsAsFactors = FALSE) %>%
filter(agg_reg == "SS",
!is.na(M)) %>%
select(year, stock, smolt, survival, M)
glimpse(surv)
dat <- cov %>%
select(year, metric, env_anomaly = anomaly) %>%
nest(data = c(year, anomaly)) %>%
mutate(
data2 = map(data, function (x) {
surv %>%
left_join(., x, by = "year")
})
)
dat <- cov %>%
select(year, metric, env_anomaly = anomaly) %>%
nest(data = c(year, env_anomaly)) %>%
mutate(
data2 = map(data, function (x) {
surv %>%
left_join(., x, by = "year")
})
)
dat
glimpse(surv)
dat <- cov %>%
select(year, metric, env_anomaly = anomaly) %>%
nest(data = c(year, env_anomaly)) %>%
mutate(
data = map(data, function (x) {
surv %>%
left_join(., x, by = "year")
})
)
glimpse(dat)
dat
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
glimpse()
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
glimpse() %>%
ggplot(.) +
geom_point(aes(x = M, y = env_anomaly))
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
glimpse() %>%
ggplot(.) +
geom_point(aes(x = M, y = anomaly)) +
facet_wrap(~metric)
?geom_smooth
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
ggplot(.) +
geom_point(aes(x = M, y = anomaly)) +
facet_wrap(~metric) +
geom_smooth(method = "gam")
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
ggplot(.) +
geom_point(aes(x = M, y = anomaly)) +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
ggplot(., aes(x = M, y = anomaly)) +
geom_point() +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
surv %>%
left_join(., cov, by = "year") %>%
ggplot(., aes(x = anomaly, y = M)) +
geom_point() +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
surv %>%
filter(smolt == "yearling") %>%
left_join(., cov, by = "year") %>%
ggplot(., aes(x = anomaly, y = M)) +
geom_point() +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
surv %>%
filter(smolt == "oceantype") %>%
left_join(., cov, by = "year") %>%
ggplot(., aes(x = anomaly, y = M)) +
geom_point() +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
surv %>%
filter(smolt == "streamtype") %>%
left_join(., cov, by = "year") %>%
ggplot(., aes(x = anomaly, y = M)) +
geom_point() +
geom_smooth(method = "gam") +
facet_wrap(~metric)
# raw plot
plot_dat <- surv %>%
left_join(., cov, by = "year")
glimpse(plot_dat)
# test with one covariate
temp <- plot_dat %>%
filter(metric == "seal_anom")
?gam
glimpse(temp)
m1 <- gam(M ~ s(seal_anom), data = temp)
m1 <- gam(M ~ s(anomaly), data = temp)
m2 <- gam(M ~ s(anomaly, smolt, bs = "fs"))
m2 <- gam(M ~ s(anomaly, smolt, bs = "fs"), data = temp)
m2 <- gam(M ~ s(anomaly) * s(smolt), data = temp)
glimpse(temp)
m2 <- gam(M ~ s(anomaly) * s(as.factor(smolt)), data = temp)
m2 <- gam(M ~ s(anomaly) * as.factor(smolt), data = temp)
glimpse(temp)
m2 <- gam(M ~ s(anomaly) + as.factor(smolt), data = temp)
summary(m2)
m2 <- gam(M ~ s(anomaly):as.factor(smolt), data = temp)
m2 <- gam(M ~ s(anomaly, by = smolt), data = temp)
glimpse(temp)
# test with one covariate
temp <- plot_dat %>%
filter(metric == "seal_anom") %>%
mutate(smolt = as.factor(smolt))
m1 <- gam(M ~ s(anomaly), data = temp)
m2 <- gam(M ~ s(anomaly, by = smolt), data = temp)
m3 <- gam(M ~ s(anomaly) + s(anomaly, by = smolt), data = temp)
AIC(m1, m2, m3)
summary(m2)
summary(m3)
glimpse(temp)
# test with one covariate
temp <- plot_dat %>%
filter(metric == "seal_anom") %>%
mutate(smolt = as.factor(smolt),
stock = as.factor(stock))
m3 <- gam(M ~ s(anomaly, m = 2) + s(anomaly, by = smolt, m = 1), data = temp)
m4 <- gam(M ~ s(anomaly, m = 2) + s(anomaly, by = smolt, m = 1) +
s(stock, bs = "re"),
data = temp)
AIC(m1, m2, m3, m4)
range(temp$anomaly)
range(temp$anomaly, na.rm =T)
newdat <- data.frame(
anomaly = seq(-1.5, 1, length.out = 100)
) %>%
expand.grid(.$anomaly, unique(temp$smolt))
glimpse(newdat)
seal_seq <- seq(-1.5, 1, length.out = 100)
newdat <- expand.grid(anomaly = seal_seq, smolt = unique(temp$smolt))
head(newdat)
summary(m3)
summary(m4)
new_dat <- expand.grid(anomaly = seal_seq, smolt = unique(temp$smolt))
pred_dat <- predict(m3, new_dat, se.fit = TRUE)
glimpse(pred_dat)
m3$Vp
length(unique(temp$stock))
glimpse(pred_dat)
new_dat$fit <- pred_dat$fit
head(new_dat)
new_dat$low <- new_dat$fit - (1.96 * pred_dat$se.fit)
new_dat$fit <- pred_dat$fit
new_dat$up <- new_dat$fit + (1.96 * pred_dat$se.fit)
new_dat$low <- new_dat$fit - (1.96 * pred_dat$se.fit)
?geom_ribbon
geom_ribbon(aes(ymin = low, ymax = up))
ggplot(new_dat, aes(x = anomaly)) +
geom_line(aes(y = fit)) +
geom_ribbon(aes(ymin = low, ymax = up))
glimpse(new_dat)
pred_dat$fit
pred_dat$fit[,1]
as.numeric(pred_dat$fit)
new_dat$fit <- as.numeric(pred_dat$fit)
new_dat$up <- as.numeric(new_dat$fit + (1.96 * pred_dat$se.fit))
new_dat$low <- as.numeric(new_dat$fit - (1.96 * pred_dat$se.fit))
glimspe(new_dat)
glimpse(new_dat)
ggplot(new_dat, aes(x = anomaly)) +
geom_line(aes(y = fit, color = smolt)) +
geom_ribbon(aes(ymin = low, ymax = up, fill = smolt))
ggplot(new_dat, aes(x = anomaly)) +
geom_line(aes(y = fit, color = smolt)) +
geom_ribbon(aes(ymin = low, ymax = up, fill = smolt, alpha = 0.3))
seal_seq <- seq(-1.5, 1, length.out = 200)
new_dat <- expand.grid(anomaly = seal_seq, smolt = unique(temp$smolt))
pred_dat <- predict(m3, new_dat, se.fit = TRUE)
new_dat$fit <- as.numeric(pred_dat$fit)
new_dat$up <- as.numeric(new_dat$fit + (1.96 * pred_dat$se.fit))
new_dat$low <- as.numeric(new_dat$fit - (1.96 * pred_dat$se.fit))
ggplot(new_dat, aes(x = anomaly)) +
geom_line(aes(y = fit, color = smolt)) +
geom_ribbon(aes(ymin = low, ymax = up, fill = smolt, alpha = 0.3))
