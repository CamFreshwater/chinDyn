as.matrix() %>%
t()
}
m_mat <- make_mat(surv)
# n trends = to n groups - 1
global_fit <- fit_dfa(y = m_mat, num_trends = length(unique(surv$group)) - 1,
zscore = TRUE, iter = 2000, chains = 4, thin = 1,
control = list(adapt_delta = 0.95, max_treedepth = 20))
r_global <- rotate_trends(global_fit)
# n trends = to n groups - 1
global_fit <- fit_dfa(y = m_mat, num_trends = length(unique(surv$group)) - 1,
zscore = TRUE, iter = 8000, chains = 1, thin = 1,
control = list(adapt_delta = 0.95, max_treedepth = 20))
# n trends = to n groups - 1
global_fit <- fit_dfa(y = m_mat, num_trends = length(unique(surv$group)) - 1,
zscore = TRUE, iter = 10000, chains = 1, thin = 1,
control = list(adapt_delta = 0.95, max_treedepth = 20))
r_global <- rotate_trends(global_fit)
plot_trends(r_global)
plot_fitted(global_fit6)
plot_fitted(global_fit)
plot_loadings(r_global) +
ylim(-3, 3)
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time")
trend_list <- purrr::map2(surv_tbl$rot_trends, surv_tbl$group, function (x, name) {
plot_trends(x) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red")
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
?theme
trend_list <- purrr::map2(surv_tbl$rot_trends, surv_tbl$group, function (x, name) {
plot_trends(x) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
plot_trends
?plot_trends
glimpse(surv)
trend_list <- purrr::map2(surv_tbl$rot_trends, surv_tbl$group, function (x, name) {
plot_trends(x, years = unique(surv$year)) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
})
surv_tbl
surv_tbl$m_mat[[1]]
glimpse(surv)
surv %>%
group_by(group) %>%
summarize(min_year = min(year),
max_year = max(year))
surv %>%
group_by(group) %>%
summarize(min_year = min(year),
max_year = max(year))
year_vecs <- surv %>%
group_by(group) %>%
summarize(min_year = min(year),
max_year = max(year)) %>%
mutate(year = seq(min_year, max_year, by = 1))
year_vecs <- surv %>%
group_by(group) %>%
summarize(min_year = min(year),
max_year = max(year)) %>%
group_by(group) %>%
mutate(year = seq(min_year, max_year, by = 1))
glimpse(surv)
surv %>%
select(group, year) %>%
nest(group)
surv %>%
select(group, year) %>%
nest(year)
surv %>%
select(group, year) %>%
distinct() %>%
nest(year)
surv <- read.csv(here::here("data/salmonData/cwt_indicator_surv_clean.csv"),
stringsAsFactors = FALSE) %>%
filter(!group %in% c("north_oceantype", "south_streamtype")) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
group = as.factor(group),
stock = fct_reorder(stock, as.numeric(group)))
year_vecs <- surv %>%
select(group, year) %>%
distinct() %>%
nest(year)
year_vecs <- surv %>%
select(group, year) %>%
distinct() %>%
nest(years = c(year))
year_vecs$years[[1]]
year_tbl
year_tbl <- surv %>%
select(group, year) %>%
distinct() %>%
nest(years = c(year))
year_tbl <- surv %>%
year_tbl <- surv %>%
select(group, year) %>%
distinct() %>%
nest(years = c(year))
year_tbl
glimpse(surv)
year_tbl <- surv %>%
filter(!is.na(M)) %>%
select(group, year) %>%
distinct() %>%
nest(years = c(year))
surv_tbl
surv_tbl <- readRDS(here::here("data", "dfaBayesFits",
"two-trend-fits.rds")) %>%
mutate(rot_trends = map(dfa_two_trend, rotate_trends)) %>%
left_join(., year_tbl, by = "group")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
plot_trends(surv_tbl$rot_trends[[1]], years = years[[1]]) +
# labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
plot_trends(surv_tbl$rot_trends[[1]], years = surv_tbl$years[[1]]) +
# labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
surv_tbl$years[[1]]
class(surv_tbl$years[[1]])
class(as.vector(surv_tbl$years[[1]]))
class(surv_tbl$years[[1]][,1])
class(as.numeric(surv_tbl$years[[1]]))
class(as.numeric(surv_tbl$years[[1]]$year))
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
})
plot_trends(surv_tbl$rot_trends[[1]], years = surv_tbl$years[[1]]$year) +
# labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank())
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
scale_x_continuous(breaks = c(1980, 2000, 2020)) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1980, 2000, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
?scale_x_continuous
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1970, 1975, 1990, 2005, 2020, 2022),
labels = c("", "1975", "1990", "2005", "2020", ""))
})
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
# lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1970, 1975, 1990, 2005, 2020, 2022),
labels = c("", "1975", "1990", "2005", "2020", ""))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
breaks = c(1970, 1975, 1990, 2005, 2020, 2022)
length(breaks)
labels = c("", "1975", "1990", "2005", "2020", "")
length(labels)
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
# lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1970, 1975, 1990, 2005, 2020, 2022),
labels = c("", "1975", "1990", "2005", "2020", ""))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
# lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1970, 1975, 1990, 2005, 2020, 2022))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
# lims(x = c(1970, 2020)) +
scale_x_continuous(breaks = c(1970, 1975, 1990, 2005, 2020, 2025))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
?lims
?fit_dfa
glimpse(surv_tbl$rot_trends)
glimpse(surv_tbl$dfa_two_trend[[1]])
rotate_trends
?rotate_trends
glimpse(surv_tbl$rot_trends)
trend_list[[1]]
plot_fitted(dfa_two_trend[[1]])
plot_fitted(surv_tb$dfa_two_trend[[1]])
plot_fitted(surv_tbl$dfa_two_trend[[1]])
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
surv_tbl <- readRDS(here::here("data", "dfaBayesFits",
"two-trend-fits.rds")) %>%
mutate(rot_trends = map(dfa_two_trend, rotate_trends)) %>%
left_join(., year_tbl, by = "group")
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
plot_trends(surv_tbl$rot_trends[[1]])
surv_tbl$years[[1]]$year
plot_trends(surv_tbl$rot_trends[[1]], years = surv_tbl$years[[1]]$year)
surv %>%
filter(!is.na(M)) %>%
ggplot(.) +
geom_point(aes(x = year, y = M, fill = group), shape = 21) +
facet_wrap(~ fct_reorder(stock, as.numeric(group))) +
scale_x_continuous(breaks = c(1975, 1990, 2005)) +
scale_fill_discrete(name = "Region/ \nLife History") +
labs(y = "M") +
ggsidekick::theme_sleek() +
theme(legend.position = "top")
plot_trends
surv_tbl$years[[1]]$year
year_tbl <- surv %>%
filter(!is.na(M)) %>%
select(group, year) %>%
arrange(group, year) %>%
distinct() %>%
nest(years = c(year))
year_tbl
year_tbl <- surv %>%
filter(!is.na(M)) %>%
select(group, year) %>%
arrange(group, year) %>%
distinct()
year_tbl
year_tbl <- surv %>%
filter(!is.na(M)) %>%
select(group, year) %>%
arrange(group, year) %>%
distinct() %>%
nest(years = c(year))
surv_tbl <- readRDS(here::here("data", "dfaBayesFits",
"two-trend-fits.rds")) %>%
mutate(rot_trends = map(dfa_two_trend, rotate_trends)) %>%
left_join(., year_tbl, by = "group")
plot_trends(surv_tbl$rot_trends[[1]])
plot_trends(surv_tbl$rot_trends[[1]], years = surv_tbl$years[[1]]$year)
trend_list <- purrr::pmap(list(surv_tbl$rot_trends, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
plot_trends(surv_tbl$rot_trends[[1]], years = surv_tbl$years[[1]]$year,
invert = TRUE)
plot_trends
glimpse(surv_tbl$rot_trends)
#invert trends with predominantly negative loadings
surv_tbl$rot_trends_adj = map(surv_tbl$rot_trends, function (x) {
x$trends_mean[, 2] = -1 * x$trends_mean[, 2]
x$trends_median[, 2] = -1 * x$trends_median[, 2]
x$trends_lower[, 2] = -1 * x$trends_lower[, 2]
x$trends_upper[, 2] = -1 * x$trends_upper[, 2]
})
trend_list <- purrr::pmap(list(surv_tbl$rot_trends_adj, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
glimpse(surv_tbl$rot_trends_adj)
#invert trends with predominantly negative loadings
surv_tbl$rot_trends_adj = map(surv_tbl$rot_trends, function (x) {
x$trends_mean[, 2] = -1 * x$trends_mean[, 2]
x$trends_median[, 2] = -1 * x$trends_median[, 2]
x$trends_lower[, 2] = -1 * x$trends_lower[, 2]
x$trends_upper[, 2] = -1 * x$trends_upper[, 2]
return(x)
})
glimpse(surv_tbl$rot_trends_adj)
glimpse(surv_tbl$rot_trends)
trend_list <- purrr::pmap(list(surv_tbl$rot_trends_adj, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
#invert trends with predominantly negative loadings
surv_tbl$rot_trends_adj = map(surv_tbl$rot_trends, function (x) {
x$trends_mean[, 2] = -1 * x$trends_mean[, 2]
x$trends_median[, 2] = -1 * x$trends_median[, 2]
x$trends_lower[, 2] = -1 * x$trends_lower[, 2]
x$trends_upper[, 2] = -1 * x$trends_upper[, 2]
return(x)
})
trend_list <- purrr::pmap(list(surv_tbl$rot_trends_adj, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
plot_trends
x <- surv_tbl$rot_trends[[1]]
x$trends_mean[, 2]
x$trends_mean
#invert trends with predominantly negative loadings
surv_tbl$rot_trends_adj = map(surv_tbl$rot_trends, function (x) {
x$trends_mean[, 2] = -1 * x$trends_mean[2, ]
x$trends_median[, 2] = -1 * x$trends_median[2, ]
x$trends_lower[, 2] = -1 * x$trends_lower[2, ]
x$trends_upper[, 2] = -1 * x$trends_upper[2, ]
return(x)
})
#invert trends with predominantly negative loadings
surv_tbl$rot_trends_adj = map(surv_tbl$rot_trends, function (x) {
x$trends_mean[2, ] = -1 * x$trends_mean[2, ]
x$trends_median[2, ] = -1 * x$trends_median[2, ]
x$trends_lower[2, ] = -1 * x$trends_lower[2, ]
x$trends_upper[2, ] = -1 * x$trends_upper[2, ]
return(x)
})
trend_list <- purrr::pmap(list(surv_tbl$rot_trends_adj, surv_tbl$group,
surv_tbl$years), function (x, name, years) {
plot_trends(x, years = years$year) +
labs(title = name, x = "", y = "") +
ggsidekick::theme_sleek() +
geom_hline(aes(yintercept = 0), color = "red") +
theme(axis.title = element_blank()) +
lims(x = c(1970, 2020))
})
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
head(cov)
cov %>% filter(metric == "seal_anom")
fe_splines <- dat %>%
select(metric, fixed_preds) %>%
unnest(fixed_preds) %>%
left_join(., cov %>% select(metric, class), by = "metric") %>%
# glimpse()
ggplot(.) +
geom_line(aes(x = env_anomaly, y = fit, color = smolt)) +
geom_ribbon(aes(x = env_anomaly, ymin = low, ymax = up, fill = smolt),
alpha = 0.3) +
facet_wrap(~fct_reorder(metric, as.numeric(as.factor(class))),
scales = "free_x") +
ggsidekick::theme_sleek() +
labs(x = "Environmental Anomaly", y = "Predicted Survival")
fe_splines
saveRDS(fe_splines, here::here("data", "gamFits", "fe_splines.rds"))
trend_panels <- cowplot::plot_grid(trend_list[[1]], trend_list[[2]],
trend_list[[3]], trend_list[[4]])
ggpubr::annotate_figure(trend_panels, bottom = "Time",
left = "Unitless Survival \nCoefficient")
glimpse(year_tbl)
glimpse(surv)
surv %>%
select(stock, stock_name, smolt, region) %>%
distinct()
