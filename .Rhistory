# input vectors
excl_pars <- map(mod$smooth, function(x) x$label) %>% unlist
herr0_seq <- herr1_seq <- rkw_seq <- seq(-2, 2, length.out = 99)
# stock-specific averages for each covariate
stock_means <- dat %>%
group_by(stock, a_group2) %>%
summarize(herr_OEY_z = mean(herr_OEY_z),
herr_OEY1_z = mean(herr_OEY1_z),
rkw_z2 = mean(rkw_z2),
.groups = "drop") %>%
ungroup()
# make mixed effects predictions using stock mean values
# note that order of covariates in DF varies and is important
mixed_preds_herr0 <- expand.grid(herr_OEY_z = herr0_seq,
stock = unique(dat$stock),
var = "herr0") %>%
left_join(., stock_means %>% select(-herr_OEY_z), by = "stock") %>%
select(herr_OEY_z, herr_OEY1_z, rkw_z2, stock, var, a_group2)
mixed_preds_herr1 <- expand.grid(herr_OEY1_z = herr1_seq,
stock = unique(dat$stock),
var = "herr1") %>%
left_join(., stock_means %>% select(-herr_OEY1_z), by = "stock") %>%
select(herr_OEY1_z, herr_OEY_z, rkw_z2, stock, var, a_group2)
mixed_preds_rkw <- expand.grid(rkw_z2 = rkw_seq,
stock = unique(dat$stock),
var = "rkw") %>%
left_join(., stock_means %>% select(-rkw_z2), by = "stock") %>%
select(rkw_z2, herr_OEY_z, herr_OEY1_z, stock, var, a_group2)
mixed_pred_list1 <- list(herr0 = mixed_preds_herr0,
herr1 = mixed_preds_herr1,
rkw = mixed_preds_rkw)
## mixed effects predictions for plotting
mixed_pred_dat <- map(mixed_pred_list1, function (x) {
gen_pred(mod, x, random = TRUE)
}) %>%
bind_rows() %>%
# left_join(., dat %>% select(stock, a_group2), by = "stock") %>%
mutate(a_group2 = fct_relevel(a_group2, "offshore", "north", "broad",
"south"))
fixed_pred_list1 <- map(mixed_pred_list1, function(x) {
#replace stock-specific covariates with 0s
x[, 2] <- 0
x[, 3] <- 0
x %>%
select(-stock) %>%
# adult grouping predictions only relevant for rkw
mutate(a_group2 = ifelse(var == "rkw", as.character(a_group2), "south")) %>%
distinct()
})
fixed_pred_dat <- map(fixed_pred_list1, function (x) {
gen_pred(mod, x, random = FALSE)
}) %>%
bind_rows() %>%
distinct() %>%
mutate(a_group2 = fct_relevel(a_group2, "offshore", "north", "south"))
# plot fixed effects (separate panels because rkw need to be plotted by
# a_group)
fe_splines1 <- fixed_pred_dat %>%
filter(var %in% c("herr0", "herr1")) %>%
ggplot(., aes(x = cov1)) +
geom_line(aes(y = pred_gen)) +
geom_ribbon(aes(ymin = pred_gen_lo, ymax = pred_gen_up),
alpha = 0.3) +
ggsidekick::theme_sleek() +
facet_wrap(~var) +
lims(y = c(min(fixed_pred_dat$pred_gen_lo),
max(fixed_pred_dat$pred_gen_up))) +
theme(axis.title.x=element_blank(),
axis.title.y=element_blank())
fe_splines2 <- fixed_pred_dat %>%
filter(var == "rkw") %>%
mutate(rkw_eff = paste(var, a_group2, sep = "_")) %>%
ggplot(., aes(x = cov1)) +
geom_line(aes(y = pred_gen, colour = a_group2)) +
geom_ribbon(aes(ymin = pred_gen_lo, ymax = pred_gen_up, fill = a_group2),
alpha = 0.3) +
ggsidekick::theme_sleek() +
facet_wrap(~fct_reorder(rkw_eff, as.numeric(a_group2))) +
lims(y = c(min(fixed_pred_dat$pred_gen_lo),
max(fixed_pred_dat$pred_gen_up))) +
theme(legend.position = "none",
axis.title.x=element_blank(),
axis.title.y=element_blank())
p <- ggpubr::ggarrange(fe_splines1, fe_splines2, nrow = 2)
png(here::here("figs", "gam", "gen_gam", "herr_rkw_fe_splines.png"),
height = 5.5, width = 7.5, res = 300, units = "in")
ggpubr::annotate_figure(p, bottom = "Z-Scaled Predictor",
left = "Predicted Generation Length")
dev.off()
162+1
163*.15
87+7.5+13.8
87+7.5
*.15
94.5*.15
(94.5*1.15)
(94.5*1.15) + 187.450
24.45+14.175
92192/26
85009/26
by_dat <- readRDS(here::here("data", "salmonData",
"cwt_indicator_surv_clean.RDS"))
glimpse(by_dat)
require(tidyverse); require(here)
by_dat <- readRDS(here::here("data", "salmonData",
"cwt_indicator_surv_clean.RDS"))
glimpse(by_dat)
by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct()
by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
write.csv(groupings_table, here::here("data", "salmonData",
"groupings_table.csv"),
row.names = FALSE)
require(tidyverse); require(here)
# new survival data
by_raw <- read.csv(here::here("data","salmonData",
"cwt_indicator_surv_sep2020.csv"),
stringsAsFactors = FALSE)
colnames(by_raw)[1] <- "year"
stock_key <- data.frame(
stock = colnames(by_raw)[2:58],
stock_name = t(by_raw[1, 2:58])
) %>%
rename(stock_name = X1)
by_dat1 <- by_raw[-1, ] %>%
pivot_longer(., 2:ncol(.), names_to = "stock", values_to = "survival") %>%
left_join(., stock_key, by = "stock") %>%
mutate(survival = as.numeric(survival),
brood_year = as.numeric(year)) %>%
select(brood_year, stock, stock_name, survival) %>%
arrange(stock)
# mean generation length data
gen1 <- read.csv(here::here("data/salmonData/cwt_indicator_generation_time.csv")) %>%
mutate(stock = as.factor(Stock)) %>%
select(stock, brood_year = BY,
gen_length = GenTim.fishing.mortality.represented.in.calcuations.)
# import version cleaned by hand (added lat/longs and two systems HOK and SMK)
metadata <- read.csv(here::here("data", "salmonData", "metadata_clean.csv"))
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year"))
glimpse(by_dat)
unique(by_dat$region)
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year")) %>%
mutate(lat = as.numeric(lat),
long = as.numeric(long),
M = -log(survival),
# change Elwha's region given catch dist similar to Puget
region = ifelse(stock == "ELW", "NPGSD", region),
j_group = case_when(
(lat > 52 & !region == "UFR") ~ "north",
stock_name == "Transboundary Rivers" ~ "north",
region %in% c("JFUCA", "LCOLR", "MCOLR", "ORCST", "UCOLR", "WACST",
"WCVI") ~ "south",
TRUE ~ "salish"
),
a_group2 = case_when(
#subset of ECVI stocks are north-migrating
stock_name %in% c("Puntledge River Summer", "Quinsam River Fall") ~
"north",
region %in% c("ECVI", "LFR", "HOODC", "SPGSD", "NPGSD") ~ "south",
smoltType == "streamtype" ~ "offshore",
region == "LCOLR" ~ "broad",
TRUE ~ "north"
),
a_group = case_when(
a_group2 == "offshore" ~ "offshore",
TRUE ~ "shelf"
),
run = tolower(adultRunTiming),
# split sog and puget
j_group2 = case_when(
region %in% c("HOODC", "SPGSD", "NPGSD") ~ "puget",
j_group == "salish" ~ "sog",
TRUE ~ j_group
),
# split columbia and other California Current stocks
j_group3 = case_when(
grepl("COLR", region) ~ "col",
TRUE ~ j_group2
),
# split by life histories
j_group4 = paste(j_group2, smoltType, sep = "_"),
# split salish resident stocks from non
a_group3 = case_when(
stock_name %in% c("Big Qualicum River Fall", "Chilliwack River Fall",
"Cowichan River Fall", "Nanaimo River Fall",
"Harrison River") ~ "sog",
j_group2 == "puget" ~ "puget",
TRUE ~ a_group2
)
) %>%
select(stock, stock_name, brood_year, survival, M, gen_length,
jurisdiction, smolt = smoltType, run,
region:long, j_group, j_group2, j_group3, j_group4, a_group, a_group2,
a_group3) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
smolt = as.factor(smolt),
j_group = as.factor(j_group),
j_group2 = as.factor(j_group2),
j_group3 = as.factor(j_group3),
j_group4 = as.factor(j_group4),
a_group =  as.factor(a_group),
a_group2 = as.factor(a_group2),
a_group3 = as.factor(a_group3))
by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
write.csv(groupings_table, here::here("data", "salmonData",
"groupings_table.csv"),
row.names = FALSE)
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
write.csv(groupings_table, here::here("data", "salmonData",
"groupings_table.csv"),
row.names = FALSE)
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year")) %>%
mutate(lat = as.numeric(lat),
long = as.numeric(long),
M = -log(survival),
# change Elwha's region given catch dist similar to Puget
region = ifelse(stock == "ELW", "NPGSD", region),
j_group = case_when(
(lat > 52 & !region == "UFR") ~ "north",
stock_name == "Transboundary Rivers" ~ "north",
region %in% c("JFUCA", "LCOLR", "MCOLR", "ORCST", "UCOLR", "WACST",
"WCVI") ~ "south",
TRUE ~ "salish"
),
a_group2 = case_when(
#subset of ECVI stocks are north-migrating
stock_name %in% c("Puntledge River Summer", "Quinsam River Fall") ~
"north",
region %in% c("ECVI", "LFR", "HOODC", "SPGSD", "NPGSD") ~ "south",
smoltType == "streamtype" ~ "offshore",
region == "LCOLR" ~ "broad",
TRUE ~ "north"
),
a_group = case_when(
a_group2 == "offshore" ~ "offshore",
TRUE ~ "shelf"
),
run = tolower(adultRunTiming),
# split sog and puget
j_group2 = case_when(
region %in% c("HOODC", "SPGSD", "NPGSD") ~ "puget",
j_group == "salish" ~ "sog",
TRUE ~ j_group
),
# split columbia and other California Current stocks
j_group3 = case_when(
grepl("COLR", region) ~ "col",
TRUE ~ j_group2
),
# split by life histories
j_group4 = paste(j_group2, smoltType, sep = "_"),
# split salish resident stocks from non
a_group3 = case_when(
stock_name %in% c("Big Qualicum River Fall", "Chilliwack River Fall",
"Cowichan River Fall", "Nanaimo River Fall",
"Harrison River") ~ "sog",
j_group2 == "puget" ~ "puget",
TRUE ~ a_group2
)
) %>%
select(stock, stock_name, brood_year, survival, M, gen_length,
jurisdiction, smolt = smoltType, run,
region:long, j_group, j_group2, j_group3, j_group4, a_group, a_group2,
a_group3) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
smolt = as.factor(smolt),
j_group = as.factor(j_group),
j_group2 = as.factor(j_group2),
j_group3 = as.factor(j_group3),
j_group4 = as.factor(j_group4),
a_group =  as.factor(a_group),
a_group2 = as.factor(a_group2),
a_group3 = as.factor(a_group3))
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
groupings_table
# import version cleaned by hand (added lat/longs and two systems HOK and SMK)
metadata <- read.csv(here::here("data", "salmonData", "metadata_clean.csv"))
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year")) %>%
mutate(lat = as.numeric(lat),
long = as.numeric(long),
M = -log(survival),
# change Elwha's region given catch dist similar to Puget
region = ifelse(stock == "ELW", "NPGSD", region),
j_group = case_when(
(lat > 52 & !region == "UFR") ~ "north",
stock_name == "Transboundary Rivers" ~ "north",
region %in% c("JFUCA", "LCOLR", "MCOLR", "ORCST", "UCOLR", "WACST",
"WCVI") ~ "south",
TRUE ~ "salish"
),
a_group2 = case_when(
#subset of ECVI stocks are north-migrating
stock_name %in% c("Puntledge River Summer", "Quinsam River Fall") ~
"north",
region %in% c("ECVI", "LFR", "HOODC", "SPGSD", "NPGSD") ~ "south",
smoltType == "streamtype" ~ "offshore",
region == "LCOLR" ~ "broad",
TRUE ~ "north"
),
a_group = case_when(
a_group2 == "offshore" ~ "offshore",
TRUE ~ "shelf"
),
run = tolower(adultRunTiming),
# split sog and puget
j_group2 = case_when(
region %in% c("HOODC", "SPGSD", "NPGSD") ~ "puget",
j_group == "salish" ~ "sog",
TRUE ~ j_group
),
# split columbia and other California Current stocks
j_group3 = case_when(
grepl("COLR", region) ~ "col",
TRUE ~ j_group2
),
# split by life histories
j_group4 = paste(j_group2, smoltType, sep = "_"),
# split salish resident stocks from non
a_group3 = case_when(
stock_name %in% c("Big Qualicum River Fall", "Chilliwack River Fall",
"Cowichan River Fall", "Nanaimo River Fall",
"Harrison River") ~ "sog",
j_group2 == "puget" ~ "puget",
TRUE ~ a_group2
)
) %>%
select(stock, stock_name, brood_year, survival, M, gen_length,
jurisdiction, smolt = smoltType, run,
region:long, j_group, j_group2, j_group3, j_group4, a_group, a_group2,
a_group3) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
smolt = as.factor(smolt),
j_group = as.factor(j_group),
j_group2 = as.factor(j_group2),
j_group3 = as.factor(j_group3),
j_group4 = as.factor(j_group4),
a_group =  as.factor(a_group),
a_group2 = as.factor(a_group2),
a_group3 = as.factor(a_group3))
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
groupings_table
groupings_table <- by_dat %>%
select(stock, stock_name, smolt, run, juvenile_grouping = j_group3,
adult_grouping = a_group2) %>%
distinct() %>%
arrange(juvenile_grouping)
write.csv(groupings_table, here::here("data", "salmonData",
"groupings_table.csv"),
row.names = FALSE)
require(tidyverse); require(here)
# new survival data
by_raw <- read.csv(here::here("data","salmonData",
"cwt_indicator_surv_sep2020.csv"),
stringsAsFactors = FALSE)
colnames(by_raw)[1] <- "year"
stock_key <- data.frame(
stock = colnames(by_raw)[2:58],
stock_name = t(by_raw[1, 2:58])
) %>%
rename(stock_name = X1)
by_dat1 <- by_raw[-1, ] %>%
pivot_longer(., 2:ncol(.), names_to = "stock", values_to = "survival") %>%
left_join(., stock_key, by = "stock") %>%
mutate(survival = as.numeric(survival),
brood_year = as.numeric(year)) %>%
select(brood_year, stock, stock_name, survival) %>%
arrange(stock)
# mean generation length data
gen1 <- read.csv(here::here("data/salmonData/cwt_indicator_generation_time.csv")) %>%
mutate(stock = as.factor(Stock)) %>%
select(stock, brood_year = BY,
gen_length = GenTim.fishing.mortality.represented.in.calcuations.)
# import version cleaned by hand (added lat/longs and two systems HOK and SMK)
metadata <- read.csv(here::here("data", "salmonData", "metadata_clean.csv"))
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year")) %>%
mutate(
lat = as.numeric(lat),
long = as.numeric(long),
M = -log(survival),
# change Elwha's region given catch dist similar to Puget
region = ifelse(stock == "ELW", "NPGSD", region),
j_group = case_when(
(lat > 52 & !region == "UFR") ~ "north",
stock_name == "Transboundary Rivers" ~ "north",
region %in% c("JFUCA", "LCOLR", "MCOLR", "ORCST", "UCOLR", "WACST",
"WCVI") ~ "south",
TRUE ~ "salish"
),
a_group2 = case_when(
#subset of ECVI stocks are north-migrating
stock_name %in% c("Puntledge River Summer", "Quinsam River Fall",
"Lyons Ferry Yearling", "Willamette Spring",
"Atnarko Yearling", "Kitsumkalum Yearling") ~ "north",
region %in% c("ECVI", "LFR", "HOODC", "SPGSD", "NPGSD") ~ "south",
smoltType == "streamtype" ~ "offshore",
region == "LCOLR" ~ "broad",
TRUE ~ "north"
),
a_group = case_when(
a_group2 == "offshore" ~ "offshore",
TRUE ~ "shelf"
),
run = tolower(adultRunTiming),
# split sog and puget
j_group2 = case_when(
region %in% c("HOODC", "SPGSD", "NPGSD") ~ "puget",
j_group == "salish" ~ "sog",
TRUE ~ j_group
),
# split columbia and other California Current stocks
j_group3 = case_when(
grepl("COLR", region) ~ "col",
TRUE ~ j_group2
),
# split by life histories
j_group4 = paste(j_group2, smoltType, sep = "_"),
# split salish resident stocks from non
a_group3 = case_when(
stock_name %in% c("Big Qualicum River Fall", "Chilliwack River Fall",
"Cowichan River Fall", "Nanaimo River Fall",
"Harrison River") ~ "sog",
j_group2 == "puget" ~ "puget",
TRUE ~ a_group2
)
) %>%
select(stock, stock_name, brood_year, survival, M, gen_length,
jurisdiction, smolt = smoltType, run,
region:long, j_group, j_group2, j_group3, j_group4, a_group, a_group2,
a_group3) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
smolt = as.factor(smolt),
j_group = as.factor(j_group),
j_group2 = as.factor(j_group2),
j_group3 = as.factor(j_group3),
j_group4 = as.factor(j_group4),
a_group =  as.factor(a_group),
a_group2 = as.factor(a_group2),
a_group3 = as.factor(a_group3))
by_dat %>% filter(a_group2 == "north")
by_dat %>% filter(a_group2 == "north") %>% pull(stock_name) %>% unique()
saveRDS(by_dat,
here::here("data", "salmonData", "cwt_indicator_surv_clean.RDS"))
