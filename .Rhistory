j_group = y
)
}) %>%
bind_rows() %>%
glimpse()
glimpse(surv_tbl)
glimpse(surv_tbl$years)
# Make 4 panel plot of dominant trends by juvenile grouping
pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(., aes(ymin = lo, ymax = hi)) +
facet_wrap(~j_group)
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi)) +
facet_wrap(~j_group)
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group)
glimpse(rot_list[[1]])
?rotate_trends
rotate_trends
-log(0.05)
exp(-1 * 2.995732)
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = exp(-1 * x$trends_mean[1, ]),
lo = exp(-1 * x$trends_lower[1, ]),
hi = exp(-1 * x$trends_upper[1, ]),
j_group = y,
years = z
)
}) %>%
bind_rows()
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group)
glimpse(surv)
range(surv$M)
hist(surv$M)
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
j_group = y,
years = z
)
}) %>%
bind_rows()
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group)
kept_grps
stk_tbl
surv <- readRDS(here::here("data/salmonData/cwt_indicator_surv_clean.RDS")) %>%
#remove stocks that are aggregates of others on CP's advice
# TST combines STI/TAK and AKS combines SSA and NSA
filter(!stock %in% c("TST", "AKS"),
year < 2017)
# dataframe of only stocks and juvenile groupings
stk_tbl <- surv %>%
select(stock, stock_name, smolt, j_group:j_group3) %>%
distinct()
stk_tbl
require(tidyverse); require(here)
# new survival data
by_raw <- read.csv(here::here("data","salmonData",
"cwt_indicator_surv_sep2020.csv"),
stringsAsFactors = FALSE)
colnames(by_raw)[1] <- "year"
stock_key <- data.frame(
stock = colnames(by_raw)[2:58],
stock_name = t(by_raw[1, 2:58])
) %>%
rename(stock_name = X1)
by_dat1 <- by_raw[-1, ] %>%
pivot_longer(., 2:ncol(.), names_to = "stock", values_to = "survival") %>%
left_join(., stock_key, by = "stock") %>%
mutate(survival = as.numeric(survival),
brood_year = as.numeric(year)) %>%
select(brood_year, stock, stock_name, survival) %>%
arrange(stock)
# mean generation length data
gen1 <- read.csv(here::here("data/salmonData/cwt_indicator_generation_time.csv")) %>%
mutate(stock = as.factor(Stock)) %>%
select(stock, brood_year = BY,
gen_length = GenTim.fishing.mortality.represented.in.calcuations.)
glimpse(gen1)
# import version cleaned by hand (added lat/longs and two systems HOK and SMK)
metadata <- read.csv(here::here("data", "salmonData", "metadata_clean.csv"))
by_dat <- metadata %>%
left_join(.,
expand.grid(brood_year = unique(by_dat1$brood_year),
stock = unique(metadata$stock)),
by = "stock") %>%
left_join(., by_dat1, by = c("stock", "stock_name", "brood_year")) %>%
full_join(., gen1, by = c("stock", "brood_year")) %>%
mutate(lat = as.numeric(lat),
long = as.numeric(long),
M = -log(survival),
# change Elwha's region given catch dist similar to Puget
region = ifelse(stock == "ELW", "NPGSD", region),
j_group = case_when(
(lat > 52 & !region == "UFR") ~ "north",
stock_name == "Transboundary Rivers" ~ "north",
region %in% c("JFUCA", "LCOLR", "MCOLR", "ORCST", "UCOLR", "WACST",
"WCVI") ~ "south",
TRUE ~ "salish"
),
a_group2 = case_when(
#subset of ECVI stocks are north-migrating
stock_name %in% c("Puntledge River Summer", "Quinsam River Fall") ~
"north",
region %in% c("ECVI", "LFR", "HOODC", "SPGSD", "NPGSD") ~ "south",
smoltType == "streamtype" ~ "offshore",
region == "LCOLR" ~ "broad",
TRUE ~ "north"
),
a_group = case_when(
a_group2 == "offshore" ~ "offshore",
TRUE ~ "shelf"
),
run = tolower(adultRunTiming),
# split sog and puget
j_group2 = case_when(
region %in% c("HOODC", "SPGSD", "NPGSD") ~ "puget",
j_group == "salish" ~ "sog",
TRUE ~ j_group
),
j_group3 = paste(j_group2, smoltType, sep = "_"),
# split salish resident stocks from non
a_group3 = case_when(
stock_name %in% c("Big Qualicum River Fall", "Chilliwack River Fall",
"Cowichan River Fall", "Nanaimo River Fall",
"Harrison River") ~ "sog",
j_group2 == "puget" ~ "puget",
TRUE ~ a_group2
)
) %>%
select(stock, stock_name, brood_year, survival, M, gen_length,
jurisdiction, smolt = smoltType, run,
region:long, j_group, j_group2, j_group3, a_group, a_group2,
a_group3) %>%
mutate_at(vars(stock), list(~ factor(., levels = unique(.)))) %>%
mutate(year = ifelse(smolt == "streamtype", brood_year + 2,
brood_year + 1),
smolt = as.factor(smolt),
j_group = as.factor(j_group),
j_group2 = as.factor(j_group2),
j_group3 = as.factor(j_group3),
a_group =  as.factor(a_group),
a_group2 = as.factor(a_group2),
a_group3 = as.factor(a_group3))
glimpse(by_dat)
by_dat %>% filter(stock_name == "Nooksack Spring Fingerling")
saveRDS(by_dat,
here::here("data", "salmonData", "cwt_indicator_surv_clean.RDS"))
# dataframe of only stocks and juvenile groupings
stk_tbl <- surv %>%
select(stock, stock_name, smolt, j_group:j_group3) %>%
distinct()
surv <- readRDS(here::here("data/salmonData/cwt_indicator_surv_clean.RDS")) %>%
#remove stocks that are aggregates of others on CP's advice
# TST combines STI/TAK and AKS combines SSA and NSA
filter(!stock %in% c("TST", "AKS"),
year < 2017)
# dataframe of only stocks and juvenile groupings
stk_tbl <- surv %>%
select(stock, stock_name, smolt, j_group:j_group3) %>%
distinct()
stk_tbl
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group)
rot_list[[1]]$Z_rot_mean
cbind(rot_list[[1]]$trends_mean,
rot_list[[1]]$trends_lower) %>%
as.data.frame()
cbind(t(rot_list[[1]]$trends_mean),
t(rot_list[[1]]$trends_lower)) %>%
as.data.frame()
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = c(x$trends_mean[1, ], x$trends_mean[2, ]),
lo = c(x$trends_lower[1, ], x$trends_lower[2, ]),
hi = c(x$trends_upper[1, ], x$trends_upper[2, ]),
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
rep(c("trend1", "trend2"), each = 25)
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = c(x$trends_mean[1, ], x$trends_mean[2, ]),
lo = c(x$trends_lower[1, ], x$trends_lower[2, ]),
hi = c(x$trends_upper[1, ], x$trends_upper[2, ]),
trend = rep(c("trend1", "trend2"), each = length(z)),
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
tail(rot_dat)
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(j_group~trend)
ggplot(rot_dat, aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_grid(j_group~trend)
rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group, ncol = 1) +
ggsidekick::theme_sleek()
glimpse(surv)
rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group, ncol = 1) +
ggsidekick::theme_sleek() +
labs(x = "Brood Year", y = "Shared Trend")
png(here::here("figs", "gam", "dfa", "bayes", "mortality",
"trend_all_groups.png"),
height = 6.25, width = 4.5, res = 300, units = "in")
trends
dev.off()
trends <- rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~j_group, ncol = 1) +
ggsidekick::theme_sleek() +
labs(x = "Brood Year", y = "Shared Trend")
png(here::here("figs", "gam", "dfa", "bayes", "mortality",
"trend_all_groups.png"),
height = 6.25, width = 4.5, res = 300, units = "in")
trends
dev.off()
dev.off()
here::here("figs", "gam", "dfa", "bayes", "mortality",
"trend_all_groups.png")
png(here::here("figs", "dfa", "bayes", "mortality", "trend_all_groups.png"),
height = 6.25, width = 4.5, res = 300, units = "in")
trends
dev.off()
stock_key
glimpse(surv)
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, kept_grps$j_group3, surv_tbl$years),
function(x, y, z) {
data.frame(
mean = c(x$trends_mean[1, ], x$trends_mean[2, ]),
lo = c(x$trends_lower[1, ], x$trends_lower[2, ]),
hi = c(x$trends_upper[1, ], x$trends_upper[2, ]),
trend = rep(c("trend1", "trend2"), each = length(z)),
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
left_join(., surv %>% select(smolt, j_group = j_group3) %>% distinct,
by = "j_group") %>%
glimpse()
trends <- rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~fct_reorder(j_group, as.numeric(smolt))) +
ggsidekick::theme_sleek() +
labs(x = "Brood Year", y = "Shared Trend")
trends
trends <- rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean, colour = smolt)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi, fill = smolt), alpha = 0.3) +
facet_wrap(~j_group) +
ggsidekick::theme_sleek() +
labs(x = "Brood Year", y = "Shared Trend")
trends
png(here::here("figs", "dfa", "bayes", "mortality", "trend_all_groups.png"),
height = 6.25, width = 4.5, res = 300, units = "in")
trends
dev.off()
png(here::here("figs", "dfa", "bayes", "mortality", "trend_all_groups.png"),
height = 6.25, width = 7.5, res = 300, units = "in")
trends
dev.off()
png(here::here("figs", "dfa", "bayes", "mortality", "trend_all_groups.png"),
height = 5.5, width = 7.5, res = 300, units = "in")
trends
dev.off()
rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean, colour = smolt)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi, fill = smolt), alpha = 0.3) +
facet_wrap(~j_group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean, colour = smolt)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi, fill = smolt), alpha = 0.3) +
facet_wrap(~j_group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0, linetype = 2) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
trends <- rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean, colour = smolt)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi, fill = smolt), alpha = 0.3) +
facet_wrap(~j_group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0, linetype = 2) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
png(here::here("figs", "dfa", "bayes", "mortality", "trend_all_groups.png"),
height = 5.5, width = 7.5, res = 300, units = "in")
trends
dev.off()
library(MARSS)
library(tidyverse)
gen_raw <- readRDS(here::here("data", "salmonData", "cwt_indicator_surv_clean.RDS"))
#remove stocks with no gen_length data
gen <- gen_raw %>%
filter(!is.na(gen_length)) %>%
mutate(gen_z = as.numeric(scale(gen_length)))
# dataframe of only stocks and adult groupings
stk_tbl <- gen %>%
group_by(stock) %>%
mutate(max_age = ceiling(max(gen_length)),
max_ocean_age = ifelse(smolt == "oceantype", max_age - 1,
max_age - 2)) %>%
ungroup() %>%
select(stock, stock_name, smolt, run, j_group2, a_group:a_group3,
max_age, max_ocean_age) %>%
distinct()
library(bayesdfa)
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
a_palette <- disco::disco("muted", n = length(unique(gen$a_group2)))
names(a_palette) <- unique(gen$a_group2)
#helper function to spread and label input matrices for bayesdfa
make_mat <- function(x) {
mat1 <- x %>%
select(year, stock, gen_length) %>%
spread(key = stock, value = gen_length) %>%
as.matrix()
out_mat <- t(mat1[, 2:ncol(mat1)])
colnames(out_mat) <- mat1[, "year"]
return(out_mat)
}
# number of stocks per group
kept_grps <- stk_tbl %>%
group_by(a_group2) %>%
tally() %>%
filter(n > 2)
#generate tbl by group
gen_tbl <- tibble(group = levels(gen$a_group2)) %>%
mutate(
gen_mat = gen %>%
filter(!is.na(gen_length)) %>%
group_split(a_group2) %>%
map(., make_mat)
) %>%
# remove groups with less than three time series
filter(
group %in% kept_grps$a_group2
)
gen_tbl$names <- map(gen_tbl$gen_mat, function (x) {
data.frame(stock = row.names(x)) %>%
left_join(., gen %>% select(stock, stock_name) %>% distinct(),
by = "stock")
})
gen_tbl$years <- map(gen_tbl$gen_mat, function (x) {
as.numeric(colnames(x))
})
# specify one trend if there are less than 4 time series, otherwise 2
n_trend_list <- ifelse(unlist(map(gen_tbl$gen_mat, nrow)) < 4, 1, 2)
# read outputs
dfa_fits2 <- map(gen_tbl$group, function(y) {
f_name <- paste(y, "bayesdfa.RDS", sep = "_")
readRDS(here::here("data", "generation_fits", f_name))
})
rot_list <- map(dfa_fits2, rotate_trends)
gen_tbl
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, gen_tbl$group, gen_tbl$years),
function(x, y, z) {
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
j_group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
group = y,
years = z
)
# Make 4 panel plot of dominant trends by juvenile grouping
rot_dat <- pmap(list(rot_list, gen_tbl$group, gen_tbl$years),
function(x, y, z) {
data.frame(
mean = x$trends_mean[1, ],
lo = x$trends_lower[1, ],
hi = x$trends_upper[1, ],
group = y,
years = z
)
}) %>%
bind_rows() %>%
glimpse()
rot_dat %>%
filter(trend == "trend1") %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0, linetype = 2) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
rot_dat %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0, linetype = 2) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
trends <- rot_dat %>%
ggplot(., aes(x = years, y = mean)) +
geom_line() +
geom_ribbon(aes(ymin = lo, ymax = hi), alpha = 0.3) +
facet_wrap(~group) +
ggsidekick::theme_sleek() +
geom_hline(yintercept = 0, linetype = 2) +
labs(x = "Brood Year", y = "Shared Trend") +
theme(legend.position = "top")
png(here::here("figs", "dfa", "bayes", "generation_length", "trend_all_groups.png"),
height = 5.5, width = 7.5, res = 300, units = "in")
trends
dev.off()
marss_aic_tab <- readRDS(here::here("data", "generation_fits",
"marss_aic_tab.RDS"))
marss_aic_tab
stk_tbl$a_group2
stk_tbl$a_group3
