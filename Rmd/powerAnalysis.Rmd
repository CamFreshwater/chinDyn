---
title: "Power Analysis for Tagging"
author: "Cam Freshwater"
date: "April 8, 2019"
output: html_document
---
How many individuals necessary to estimate a) duration of residence and b) stock composition?

Principle steps for power analysis
  1. Level of precision desired - here we'll assume that either 10% or 25% precision is sufficient
  2. Find equation that links sample size w/ desired precision - e.g. for normal (n = ((t * s)/d)^2)
  3. Estimate or guess unknown parameters (here use duration of residence of migrating juvenile sockeye salmon in similar sized habitat, then double it)

```{r estSampleSize1, echo=TRUE}
require(here)
soxDat <- read.csv(here("data/salmonData/soxOtolithData.csv"), stringsAsFactors = FALSE) 
lowMigSD <- round(sd(soxDat$incrementCount), digits = 0)
highMigSD <- 2 * lowMigSD
lowPrec <- 5 #low absolute precision is 5 days
highPrec <- 2 #high is 2 days
tAlpha <- 2 # assume t_alpha is ~2 
mu <- 20 #totally random mean

# Assumes normal distribute so may be little funky
calcPower <- function(t = 2, sd, prec) {
  ((t * sd) / prec)^2
}

calcPower(sd = lowMigSD, prec = lowPrec) #23 fish (optimisitic)
calcPower(sd = lowMigSD, prec = highPrec) #145 fish (optimisitic)
calcPower(sd = highMigSD, prec = highPrec) #550 fish (pessimistic)

# More correct assumption with lognormal
logD <- mean(log(soxDat$incrementCount))
logDVar <- (sd(log(soxDat$incrementCount)))^2

# Function to iterate across different sample sizes and determine what 
# percentage of the mean is included in 95% CI
estCI <- function(n., logMu, logVar) {
  mean. <- logMu + (logVar / 2) 
  int. <- 2.093 * (sqrt((logVar / n.) + ((logVar^2) / (2 * n. - 1))))
  low <- 1 - exp(mean. - int.) / exp(mean.)
  high <- exp(mean. + int.) / exp(mean.) - 1
  list(-low, high)
}
nSeq <- c(20, 50, 100, 150, 200)
out <- estCI(100, logMu = logD, logVar = logDVar)
sapply(nSeq, function(x) estCI(x, logMu = logD, logVar = logDVar))
```

Unlikely that migration SD is substantially larger than what we observed in sockeye, therefore we need somewhere between 150 and 200 fish to get an estimated 95% confidence interval that's within ~10% of the true mean. 

Next calculate minimum sample size that will allow you to detect difference of 3 days in migration timing between two populations.

```{r estSampleSize2, echo=TRUE}
dif <- 3
alpha <- 0.05 #default
beta <- 0.05 #arbitrary

relDiff <- 3 / lowMigSD
```

Based on t-table equals 106 fish *per population*.

